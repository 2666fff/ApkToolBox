name: Build and Release on Tag

on:
  push:
    tags:
      - 'v*'

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v2

      - name: Setup NuGet
        uses: NuGet/setup-nuget@v2

      - name: Restore NuGet packages
        run: nuget restore AutoAPKTool/AutoAPKTool.csproj  # 直接指定项目文件路径，避免工作目录问题

      - name: Build project
        run: msbuild AutoAPKTool/AutoAPKTool.csproj /p:Configuration=Release /p:Platform="Any CPU" /p:OutputPath=../../bin/Release

      - name: Prepare release artifacts
        run: |
          # 创建发布目录
          New-Item -Path ./release -ItemType Directory -Force
          
          # 复制编译输出文件（修正路径）
          Copy-Item -Path ./bin/Release/* -Destination ./release -Recurse
          
          # 复制工具目录（处理可能的重复路径）
          if (Test-Path ./AutoAPKTool/tool) {
              Copy-Item -Path ./AutoAPKTool/tool -Destination ./release/tool -Recurse -Force
          }
          if (Test-Path ./tool) {
              Copy-Item -Path ./tool -Destination ./release/tool -Recurse -Force
          }
          
          # 压缩为 zip 包
          Compress-Archive -Path ./release/* -DestinationPath ./ApkToolBox-${{ github.ref_name }}.zip -Force

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: ./ApkToolBox-${{ github.ref_name }}.zip
          name: Release ${{ github.ref_name }}
          body: |
            ## 更新内容
            - 自动发布版本 ${{ github.ref_name }}
            - 基于 tag 自动编译构建
            
            ## 注意事项
            - 尽量避免使用中文路径，以免编译或签名失败
            - 签名工具来自网易，签名速度比一般签名快50%~80%
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
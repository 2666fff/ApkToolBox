name: Build on Every Commit

on:
  push:
    branches: ['*']
    tags: ['*']
  pull_request:
    branches: ['*']

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v2
        with:
          msbuild-architecture: x64

      - name: Setup NuGet
        uses: NuGet/setup-nuget@v2
        with:
          nuget-version: 'latest'

      - name: Restore NuGet packages (适配.NET 4.8.1)
        run: |
          msbuild AutoAPKTool/AutoAPKTool.csproj `
            /t:Restore `
            /p:Configuration=Release
        working-directory: ${{ github.workspace }}
        shell: pwsh

      - name: Build project (.NET Framework 4.8.1)
        run: |
          # 统一输出路径到工作目录下的 bin/Release，避免跨目录问题
          msbuild AutoAPKTool/AutoAPKTool.csproj `
            /p:Configuration=Release `
            /p:Platform="Any CPU" `
            /p:OutputPath=${{ github.workspace }}/bin/Release `  # 绝对路径指定输出目录
        working-directory: ${{ github.workspace }}
        shell: pwsh

      - name: Verify build output
        run: |
          # 使用绝对路径验证，避免相对路径歧义
          $exePath = "${{ github.workspace }}/bin/Release/AutoAPKTool.exe"
          if (-not (Test-Path $exePath)) {
              Write-Error "编译失败：未找到主程序文件，路径：$exePath"
              exit 1
          }
          Write-Host "✅ .NET Framework 4.8.1 编译成功！主程序路径：$exePath"
          # 列出编译产物详情
          Get-ChildItem "${{ github.workspace }}/bin/Release" -Recurse
        working-directory: ${{ github.workspace }}
        shell: pwsh

      # 可选：打包产物（路径统一）
      # - name: Package build artifacts
      #   run: |
      #     New-Item -Path ./release -ItemType Directory -Force
      #     Copy-Item -Path "${{ github.workspace }}/bin/Release/*" -Destination ./release -Recurse
      #     if (Test-Path ./AutoAPKTool/tool) {
      #         Copy-Item -Path ./AutoAPKTool/tool -Destination ./release/tool -Recurse -Force
      #     }
      #     Compress-Archive -Path ./release/* -DestinationPath ./ApkToolBox-Build-${{ github.sha }}.zip -Force
      #   working-directory: ${{ github.workspace }}
      #   shell: pwsh

      # 可选：上传产物到Action Artifacts
      # - name: Upload build artifacts
      #   uses: actions/upload-artifact@v4
      #   with:
      #     name: ApkToolBox-Build-${{ github.sha }}
      #     path: ${{ github.workspace }}/bin/Release/
name: Build and Release

# 普通提交仅编译，Tag 提交编译+发布
on:
  push:
    branches: ['*']          # 所有分支提交仅编译
    tags: ['v*']            # 推送 Tag（如 v1.6.1）时编译+发布
  pull_request:
    branches: ['*']

jobs:
  build:
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v2
        with:
          msbuild-architecture: x64

      - name: Setup NuGet
        uses: NuGet/setup-nuget@v2

      - name: Restore NuGet packages
        run: |
          msbuild AutoAPKTool/AutoAPKTool.csproj `
            /t:Restore `
            /p:Configuration=Release
        working-directory: ${{ github.workspace }}
        shell: pwsh

      - name: Build project (.NET 4.8.1)
        run: |
          msbuild AutoAPKTool/AutoAPKTool.csproj `
            /p:Configuration=Release `
            /p:Platform="Any CPU" `
            /p:OutputPath=${{ github.workspace }}/bin/Release `
        working-directory: ${{ github.workspace }}
        shell: pwsh

      - name: Verify build
        run: |
          $exePath = "${{ github.workspace }}/bin/Release/AutoAPKTool.exe"
          if (-not (Test-Path $exePath)) {
              Write-Error "编译失败：未找到 $exePath"
              exit 1
          }
          Write-Host "✅ 编译成功！"
        working-directory: ${{ github.workspace }}
        shell: pwsh

      - name: Package artifacts
        run: |
          New-Item -Path ./release -ItemType Directory -Force
          Copy-Item -Path ${{ github.workspace }}/bin/Release/* -Destination ./release -Recurse
          if (Test-Path ./AutoAPKTool/tool) {
              Copy-Item -Path ./AutoAPKTool/tool -Destination ./release/tool -Recurse -Force
          }
          Compress-Archive -Path ./release/* -DestinationPath ./ApkToolBox-${{ github.ref_name }}.zip -Force
        working-directory: ${{ github.workspace }}
        shell: pwsh

      # 关键：仅当推送 Tag 时，才创建 Release 并上传产物
      - name: Create GitHub Release
        if: startsWith(github.ref, 'refs/tags/')  # 仅 Tag 触发此步骤
        uses: softprops/action-gh-release@v2
        with:
          files: ./ApkToolBox-${{ github.ref_name }}.zip
          name: Release ${{ github.ref_name }}
          body: |
            ## 更新内容
            - 自动发布版本 ${{ github.ref_name }}
            - 基于 .NET Framework 4.8.1 编译
            
            ## 注意事项
            - 避免中文路径，防止编译/签名失败
            - 网易签名工具，速度提升 50%~80%
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}  # 无需手动配置，GitHub 自动生成
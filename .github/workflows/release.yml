name: Build on Every Commit

on:
  push:
    branches: ['*']
    tags: ['*']
  pull_request:
    branches: ['*']

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v2
        with:
          msbuild-architecture: x64

      - name: Setup NuGet
        uses: NuGet/setup-nuget@v2
        with:
          nuget-version: 'latest'

      - name: Restore NuGet packages (适配.NET 4.8.1)
        run: |
          # 正确的还原命令：通过MSBuild参数指定框架，而非NuGet参数
          msbuild AutoAPKTool/AutoAPKTool.csproj `
            /t:Restore `
            /p:Configuration=Release
        working-directory: ${{ github.workspace }}
        shell: pwsh

      - name: Build project (.NET Framework 4.8.1)
        run: |
          msbuild AutoAPKTool/AutoAPKTool.csproj `
            /p:Configuration=Release `
            /p:Platform="Any CPU" `
            /p:OutputPath=../../bin/Release `
            /p:UseLatestPlatformToolset=true
        working-directory: ${{ github.workspace }}
        shell: pwsh

      - name: Verify build output
        run: |
          if (-not (Test-Path ./bin/Release/AutoAPKTool.exe)) {
              Write-Error "编译失败：未找到主程序文件"
              exit 1
          }
          Get-ChildItem ./bin/Release -Recurse
        working-directory: ${{ github.workspace }}
        shell: pwsh

      # 可选：打包产物（如需保留可取消注释）
      # - name: Package build artifacts
      #   run: |
      #     New-Item -Path ./release -ItemType Directory -Force
      #     Copy-Item -Path ./bin/Release/* -Destination ./release -Recurse
      #     if (Test-Path ./AutoAPKTool/tool) {
      #         Copy-Item -Path ./AutoAPKTool/tool -Destination ./release/tool -Recurse -Force
      #     }
      #     Compress-Archive -Path ./release/* -DestinationPath ./ApkToolBox-Build-${{ github.sha }}.zip -Force
      #   working-directory: ${{ github.workspace }}
      #   shell: pwsh

      # 可选：上传产物到Action Artifacts
      # - name: Upload build artifacts
      #   uses: actions/upload-artifact@v4
      #   with:
      #     name: ApkToolBox-Build-${{ github.sha }}
      #     path: ./bin/Release/
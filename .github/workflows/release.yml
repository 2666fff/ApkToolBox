name: Build on Every Commit

# 触发条件：所有分支的push提交（移除tag限制）
on:
  push:
    branches:
      - '*'  # 匹配所有分支
    tags:
      - '*'  # 兼容tag提交也触发（可选，如需仅分支提交可删除此行）
  pull_request:
    branches:
      - '*'  # PR提交也触发编译（可选，按需保留）

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v2
        with:
          # 显式指定MSBuild版本（适配.NET Framework 4.8.1）
          msbuild-architecture: x64

      - name: Setup NuGet
        uses: NuGet/setup-nuget@v2
        with:
          nuget-version: 'latest'

      - name: Restore NuGet packages
        run: |
          # 显式指定NuGet还原目标框架为4.8.1
          nuget restore AutoAPKTool/AutoAPKTool.csproj -Framework net481
        working-directory: ${{ github.workspace }}

      - name: Build project (.NET Framework 4.8.1)
        run: |
          msbuild AutoAPKTool/AutoAPKTool.csproj `
            /p:Configuration=Release `
            /p:Platform="Any CPU" `
            /p:OutputPath=../../bin/Release `
            /p:TargetFrameworkVersion=v4.8.1 `  # 强制指定目标框架
            /p:TargetFrameworkProfile="" `
            /p:UseLatestPlatformToolset=true  # 使用最新工具集兼容4.8.1
        working-directory: ${{ github.workspace }}

      - name: Verify build output
        run: |
          # 检查编译产物是否生成
          if (-not (Test-Path ./bin/Release/AutoAPKTool.exe)) {
              Write-Error "编译失败：未找到主程序文件"
              exit 1
          }
          Write-Host "✅ .NET Framework 4.8.1 编译成功！"
          
          # 可选：列出编译产物
          Get-ChildItem ./bin/Release -Recurse

      # 可选：保留打包步骤（如需每次提交生成zip包，可取消注释）
      # - name: Package build artifacts
      #   run: |
      #     New-Item -Path ./release -ItemType Directory -Force
      #     Copy-Item -Path ./bin/Release/* -Destination ./release -Recurse
      #     if (Test-Path ./AutoAPKTool/tool) {
      #         Copy-Item -Path ./AutoAPKTool/tool -Destination ./release/tool -Recurse -Force
      #     }
      #     Compress-Archive -Path ./release/* -DestinationPath ./ApkToolBox-Build-${{ github.sha }}.zip -Force
      
      # 可选：上传构建产物为Action Artifact（便于下载查看）
      # - name: Upload build artifacts
      #   uses: actions/upload-artifact@v4
      #   with:
      #     name: ApkToolBox-Build-${{ github.sha }}
      #     path: ./bin/Release/
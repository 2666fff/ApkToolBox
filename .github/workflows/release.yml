name: Build and Release on Tag

on:
  push:
    tags:
      - 'v*'  # 匹配 v 开头的标签，如 v1.0.0、v2.3.1 等

jobs:
  build:
    runs-on: windows-latest  # 保持 Windows 环境，因为是 .NET Framework 应用

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET Framework 4.0 构建工具
        uses: microsoft/setup-msbuild@v2  # 使用专门的 MSBuild 安装工具

      - name: 安装 NuGet 工具
        uses: NuGet/setup-nuget@v2

      - name: 还原 NuGet 包
        working-directory: ./ApkToolBox/AutoAPKTool
        run: nuget restore

      - name: 构建项目
        working-directory: ./ApkToolBox/AutoAPKTool
        run: |
          msbuild AutoAPKTool.csproj /p:Configuration=Release /p:Platform="Any CPU" /p:OutputPath=../bin/Release

      - name: 准备发布文件
        run: |
          # 创建发布目录
          New-Item -Path ./release -ItemType Directory
          # 复制编译输出文件
          Copy-Item -Path ./ApkToolBox/bin/Release/* -Destination ./release -Recurse
          # 复制工具目录（包含 jadx、dex2jar 等）
          Copy-Item -Path ./ApkToolBox/tool -Destination ./release/tool -Recurse
          # 压缩为 zip 包
          Compress-Archive -Path ./release/* -DestinationPath ./ApkToolBox-${{ github.ref_name }}.zip

      - name: 创建 GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: ./ApkToolBox-${{ github.ref_name }}.zip
          name: Release ${{ github.ref_name }}
          body: |
            ## 更新内容
            - 自动发布版本 ${{ github.ref_name }}
            - 基于 tag 自动编译构建
            
            ## 注意事项
            - 尽量避免使用中文路径，以免编译或签名失败
            - 签名工具来自网易，签名速度比一般签名快50%~80%
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}